apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kube-pod-not-ready
  namespace: monitoring
  labels:
    release: kind-prometheus
spec:
  groups:
    - name: rideshare-pods-alerts
      rules:
        # Pod not healthy (Pending, Unknown, Failed)
        - alert: KubernetesPodNotHealthy
          expr: |
            sum by (namespace, pod) (
              kube_pod_status_phase{phase=~"Pending|Unknown|Failed"}
            ) > 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: 'Pod {{ $labels.pod }} not healthy'
            description: 'Pod {{ $labels.namespace }}/{{ $labels.pod }} is not in Running state.'

        # Pod CrashLooping
        - alert: KubernetesPodCrashLooping
          expr: |
            increase(kube_pod_container_status_restarts_total[5m]) > 2
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: 'Pod {{ $labels.pod }} crash looping'
            description: 'Pod {{ $labels.namespace }}/{{ $labels.pod }} restarted multiple times within 5 minutes.'

        # High CPU usage (per container, handles missing limits)
        - alert: ContainerHighCpuUtilization
          expr: |
            (
              sum by (namespace, pod, container) (
                rate(container_cpu_usage_seconds_total{container!=""}[1m])
              )
              /
              sum by (namespace, pod, container) (
                kube_pod_container_resource_limits_cpu_cores{container!=""}
              )
            ) * 100
            and on(namespace, pod, container)
            kube_pod_container_resource_limits_cpu_cores{container!=""} > 0
            > 90
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: 'High CPU usage in {{ $labels.container }}'
            description: 'Container {{ $labels.namespace }}/{{ $labels.pod }}/{{ $labels.container }} is using more than 90% of its CPU limit.'

        # High Memory usage (per container, handles missing limits)
        - alert: ContainerHighMemoryUsage
          expr: |
            (
              sum by (namespace, pod, container) (
                container_memory_working_set_bytes{container!=""}
              )
              /
              sum by (namespace, pod, container) (
                kube_pod_container_resource_limits_memory_bytes{container!=""}
              )
            ) * 100
            and on(namespace, pod, container)
            kube_pod_container_resource_limits_memory_bytes{container!=""} > 0
            > 90
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: 'High memory usage in {{ $labels.container }}'
            description: 'Container {{ $labels.namespace }}/{{ $labels.pod }}/{{ $labels.container }} is using more than 90% of its memory limit.'

        # OOMKilled container detection
        - alert: KubernetesContainerOomKilled
          expr: |
            increase(kube_pod_container_status_restarts_total[10m]) > 0
            and on(namespace, pod, container)
            max_over_time(kube_pod_container_status_last_terminated_reason{reason="OOMKilled"}[10m]) == 1
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: 'Container OOMKilled'
            description: 'Container {{ $labels.container }} in {{ $labels.namespace }}/{{ $labels.pod }} was OOMKilled within the last 10 minutes.'
